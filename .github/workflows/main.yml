name: Build kernels

on:
  schedule:
    - cron: '0 0 * * 1'  # å¯æ›¿æ¢ä¸ºä¸Šé¢çš„ç¤ºä¾‹è¡¨è¾¾å¼
  workflow_dispatch:

jobs:
  build-kernel:
    runs-on: ubuntu-latest
    steps:
      - name: Set swap to 10G
        uses: pierotofy/set-swap-space@master
        with:
          swap-size-gb: 10
          
      - name: build
        run: |
          
          # ç¡®ä¿ç³»ç»Ÿæ˜¯æœ€æ–°çš„
          cd ~
          sudo apt update

          # å®‰è£…å¿…è¦çš„ä¾èµ–
          sudo apt install -y curl axel git build-essential flex bison libssl-dev \
              libncurses5-dev libelf-dev bc python3 rsync file patch
          axel https://raw.githubusercontent.com/mingmingzhichu/build/refs/heads/main/AnyKernel3-master.zip

          # å®‰è£… aarch64 å’Œ arm32 äº¤å‰ç¼–è¯‘å·¥å…·é“¾
          sudo apt install -y gcc-aarch64-linux-gnu g++-aarch64-linux-gnu \
              gcc-arm-linux-gnueabi g++-arm-linux-gnueabi

          # å…‹éš†å†…æ ¸æºç å’Œ Clang å·¥å…·é“¾
          git clone https://github.com/yaap/kernel_oneplus_sm8150.git -b sixteen kernel --depth=1
          git clone https://gitlab.com/crdroidandroid/android_prebuilts_clang_host_linux-x86_clang-r536225 clang --depth=1

          # è®¾ç½®ç¯å¢ƒå˜é‡
          export KBUILD_BUILD_USER=mmzch
          export KBUILD_BUILD_HOST=localhost
          export HOME=~/
          export CLANG_PATH=$HOME/clang/bin
          export PATH="$CLANG_PATH:$PATH"
          export CROSS_COMPILE=aarch64-linux-gnu-
          export CROSS_COMPILE_ARM32=arm-linux-gnueabi-
          export ARCH=arm64
          export SUBARCH=arm64
          export LLVM=1
          export LLVM_IAS=1

          # è¿›å…¥å†…æ ¸ç›®å½•å¹¶åº”ç”¨è¡¥ä¸
          cd kernel
          echo -e "\n===== å¼€å§‹æ›´æ–°LZ4åˆ°v1.10.0ï¼ˆä¸å¤‡ä»½ï¼‰====="

# å†…æ ¸è·¯å¾„ï¼šç”¨æˆ·ä¸»ç›®å½•ä¸‹çš„ kernel æ–‡ä»¶å¤¹
if [ ! -d "$HOME/kernel" ]; then
  echo "âŒ æœªæ‰¾åˆ°å†…æ ¸æºç ç›®å½• $HOME/kernel"
  exit 1
fi

# åˆ é™¤æ—§LZ4ç›®å½•
if [ -d "$HOME/kernel/lib/lz4" ]; then
  echo "ğŸ—‘ï¸ åˆ é™¤æ—§LZ4ç›®å½•"
  rm -rf "$HOME/kernel/lib/lz4"
fi
mkdir -p "$HOME/kernel/lib/lz4"

# ä¸‹è½½LZ4 v1.10.0æºç 
echo "ğŸ“¥ ä¸‹è½½LZ4 v1.10.0..."
rm -rf lz4_temp
git clone --tag v1.10.0 --depth 1 https://github.com/lz4/lz4.git lz4_temp

# å¤åˆ¶æ ¸å¿ƒæºç æ–‡ä»¶åˆ°å†…æ ¸ç›®å½•
echo "ğŸ”„ æ›¿æ¢æ–°LZ4æºç ..."
cp lz4_temp/lib/lz4_compress.c lz4_temp/lib/lz4_decompress.c lz4_temp/lib/lz4hc_compress.c lz4_temp/lib/lz4.h lz4_temp/lib/lz4hc.h "$HOME/kernel/lib/lz4/"

# æ¸…ç†ä¸´æ—¶æ–‡ä»¶
rm -rf lz4_temp

# éªŒè¯æ›´æ–°ç»“æœ
if [ -f "$HOME/kernel/lib/lz4/lz4_compress.c" ] && [ -f "$HOME/kernel/lib/lz4/lz4.h" ]; then
  echo -e "\nâœ… LZ4 v1.10.0 æ›´æ–°å®Œæˆï¼"
else
  echo -e "\nâŒ LZ4æ›´æ–°å¤±è´¥ï¼"
  exit 1
fi
          wget -O- https://github.com/vc-teahouse/Baseband-guard/raw/main/setup.sh | bash
          sed -i '/^config LSM$/,/^help$/{ /^[[:space:]]*default/ { /baseband_guard/! s/lockdown/lockdown,baseband_guard/ } }' security/Kconfig
          axel https://raw.githubusercontent.com/mingmingzhichu/build/refs/heads/main/tra.patch
          patch -p1 < tra.patch
          # é›†æˆ KernelSU
          curl -LSs "https://raw.githubusercontent.com/SukiSU-Ultra/SukiSU-Ultra/main/kernel/setup.sh" | bash -s nongki
          # é…ç½®å†…æ ¸é€‰é¡¹
          echo "CONFIG_KSU_MANUAL_HOOK=y" >> ~/kernel/arch/arm64/configs/gulch_defconfig
          echo "CONFIG_KSU=y" >> ~/kernel/arch/arm64/configs/gulch_defconfig
          # æ¸…ç†å¹¶é…ç½®å†…æ ¸
          make clean
          make mrproper
          make O=../out ARCH=arm64 gulch_defconfig
          # ä½¿ç”¨ Clang ç¼–è¯‘å†…æ ¸
          make -j$(nproc --all) O=../out ARCH=arm64 \
              CC=clang \
              LD=ld.lld \
              AR=llvm-ar \
              NM=llvm-nm \
              OBJCOPY=llvm-objcopy \
              OBJDUMP=llvm-objdump \
              STRIP=llvm-strip \
              CROSS_COMPILE=aarch64-linux-gnu- \
              CROSS_COMPILE_ARM32=arm-linux-gnueabi- \
              LLVM=1 \
              LLVM_IAS=1

          cd ~
          echo "ç¼–è¯‘å®Œæˆï¼å†…æ ¸é•œåƒä½äº: ~/out/arch/arm64/boot/Image.gz-dtb"
          unzip ~/AnyKernel3-master.zip -d ~/AnyKernel3-master
          cp ~/out/arch/arm64/boot/Image.gz-dtb ~/AnyKernel3-master/
      - name: Upload
        uses: actions/upload-artifact@v4
        with:
          name: AnyKernel3-master.zip
          path: ~/AnyKernel3-master/
